name: Daily Threat Intel Ingest

on:
  schedule:
    - cron: "0 0 * * *" # Runs at 00:00 UTC every day
  workflow_dispatch: # Allows you to click "Run Now" manually

jobs:
  update-db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Run Ingestor (Daily Delta)
        run: go run main.go
        # Note: Ensure your main.go accepts flags, or just run the specific file

      - name: Commit Updated DB
        run: |
          git config --global user.name 'SentinelBot'
          git config --global user.email 'sentinel@tobiwan.solutions'
          git add master_threat_db.csv
          git commit -m "Daily Intel Update: $(date +'%Y-%m-%d')" || exit 0
          git push

      - name: Prepare Pro Export
        run: |
          mkdir pro_export
          cp master_threat_db.csv pro_export/
          
          # Optional: Create a README for the data repo so it looks professional
          echo "# Enterprise Threat Database" > pro_export/README.md
          echo "Updated daily by SentinelFlow Engine." >> pro_export/README.md

      - name: Push to Pro Data Repo
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.PUBLIC_REPO_TOKEN }}
        with:
          source-directory: 'pro_export'   # <--- CHANGED: Use directory, not file
          destination-github-username: 'Tobiwan-Cloud-Solutions'
          destination-repository-name: 'ai-safety-data-pro'
          user-email: 'bot@sentinelflow.io'
          target-branch: main
          commit-message: "Daily Intel Update"


      
